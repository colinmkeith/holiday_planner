<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Holiday Planner</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    body { padding: 20px; }
    .calendar-month { border-radius: .5rem; padding: 8px; margin-bottom: 12px; }
    .month-name { font-weight: 600; text-align: center; margin-bottom: 6px; }
    .day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .day-cell { padding: 6px; min-height: 40px; display:flex; align-items:flex-start; justify-content:center; cursor: pointer; border-radius:6px; user-select: none; }
    .day-cell.disabled { opacity: 0.45; cursor: default; }
    .day-cell .date-num { font-weight: 500; }
    .weekday-headers { display:grid; grid-template-columns: repeat(7, 1fr); font-size: 0.85rem; text-align:center; margin-bottom:4px; }
    .small-muted { font-size: .9rem; }
    .day-cell:not(.disabled):hover {
      background-color: rgba(13,110,253,0.15);
      transition: background-color 0.2s ease-in-out;
    }
    .day-cell:hover { cursor:pointer }

    #selected-dates { overflow:auto; padding-left: 1rem; }
    html[data-bs-theme="light"] body { background: #f8f9fa; }
    html[data-bs-theme="light"] .weekend { background: rgba(13,110,253,0.06); }
    html[data-bs-theme="light"] .calendar-month { border: 1px solid #dee2e6; background: #fff; }
    html[data-bs-theme="light"] .day-cell.selected { background: #0d6efd !important; color: white; }
    html[data-bs-theme="light"] .holiday { outline: 2px dashed #dc3545; }
    html[data-bs-theme="light"] .weekday-headers { color:#6c757d; }

    html[data-bs-theme="light"] .small-muted { color:#6c757d; }
    html[data-bs-theme="dark"] .weekend { background: rgba(13,50,120,0.5); }
    html[data-bs-theme="dark"] .holiday { outline: 2px dashed #dc3545; }
    html[data-bs-theme="dark"] .weekday-headers { color:#6c757d; }
    html[data-bs-theme="dark"] .day-cell.selected { background: #0d6efd !important; color: white; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row g-3">
      <!-- Left: calendars -->
      <div class="col-lg-9">
        <div id="calendars" class="row g-3"></div>
      </div>

      <!-- Right: controls -->
      <div class="col-lg-3">
        <div class="card">
          <div class="card-body">
            <label class="form-label">Total Holiday</label>
            <div class="input-group mb-3">
              <input id="totalHoliday" class="form-control" type="text" placeholder="Hours left e.g. 80:00" aria-label="Total holiday (HH:MM)">
              <span class="input-group-text">hours</span>
            </div>

            <label class="form-label">Year</label>
            <select id="yearSelect" class="form-select mb-3"></select>

            <label class="form-label">Location</label>
            <select id="locationSelect" class="form-select mb-3">
              <option selected="selected" value="england-and-wales">England and Wales</option>
              <option value="scotland">Scotland</option>
              <option value="northern-ireland">Northern Ireland</option>
            </select>

            <hr>

            <div class="mb-2">
              <h6 class="card-title">Remaining Holiday</h6>
              <div>
                <span id="remainingHoliday" class="fs-5">80:00</span>
                <span class="small-muted">hours</span>
              </div>
            </div>

            <hr>

            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="card-title mb-0">Selected Dates</h6>
              <button id="clearBtn" class="btn btn-sm btn-danger">Clear</button>
            </div>
            <ul id="selected-dates" class="list-group mb-0">
              <li class="list-group-item">None</li>
            </ul>

            <hr>
            <button id="exportIcsBtn" class="btn btn-sm btn-primary mb-3">Export ICS</button>

            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="themeToggle">
              <label class="form-check-label" for="themeToggle">Dark mode</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>
/*
  Holiday planner SPA
  - Fetches bank-holidays from https://www.gov.uk/bank-holidays.json and uses 'england-and-wales'
  - Draws 12 month calendars for selected year, 3 months per row
  - Click to toggle a date, Shift+click to range-select / range-unselect using last clicked
  - Calculates used hours:
      Mon-Thu: 7 hours 45 minutes (7.75h)
      Fri: 3 hours
      Sat/Sun or public holiday: 0 hours
  - Subtracts used hours from TotalHoliday (format H:MM or HH:MM)
  - Remaining displayed as H:MM with "hours" suffix, turns red if negative
*/

const GOV_BANK_HOLIDAYS_URL = 'https://www.gov.uk/bank-holidays.json';
let publicHolidaysRawData = new Map();
let publicHolidayDates = new Map(); // ISO -> holiday name
let selectedDates = new Set();
let defaultLocation = 'england-and-wales';
let lastClickedDate = null;

function setTheme() {
  document.documentElement.setAttribute('data-bs-theme', (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'))
  // initial theme: use saved preference if available, else system preference
  let savedTheme = localStorage.getItem('holidayPlannerTheme');
  if (savedTheme !== 'light' && savedTheme !== 'dark') {
    savedTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  let currentTheme = savedTheme;
  document.documentElement.setAttribute('data-bs-theme', currentTheme);

  // theme toggle control
  const themeToggle = document.getElementById('themeToggle');
  themeToggle.checked = (currentTheme === 'dark');
  themeToggle.addEventListener('change', () => {
    currentTheme = themeToggle.checked ? 'dark' : 'light';
    document.documentElement.setAttribute('data-bs-theme', currentTheme);
    localStorage.setItem('holidayPlannerTheme', currentTheme);
  });
}

function toISODate(d) {
  return d.getFullYear() + "-" + (d.getMonth() + 1).toString().padStart(2, '0') + "-" + d.getDate();
}
function parseISODate(iso) {
  const[y, m, d] = iso.split('-').map(Number);
  return new Date(y, m - 1, d);
}
function minutesToHHMM(mins) {
  const sign = mins < 0 ? '-' : '';
  mins = Math.abs(Math.round(mins));
  return sign + Math.floor(mins / 60) + ':' + String(mins % 60).padStart(2, '0');
}
function hhmmToMinutes(hhmm) {
  const[h, m] = hhmm.split(':').map(Number);
  return h * 60 + m;
}

async function fetchBankHolidays() {
  try {
    const res = await fetch(GOV_BANK_HOLIDAYS_URL);
    const data = await res.json();
    return data;
  } catch {
    return[];
  }
}

function setPublicHolidays(year) {
  const loc = locationSelect.value;

  if (!publicHolidaysRawData[loc]) {
    loc = defaultLocation
  }
  events = publicHolidaysRawData[loc].events

  publicHolidayDates.clear();
  events.forEach(e => {
    if (e.date.startsWith(year)) publicHolidayDates.set(e.date, e.title);
  });
}

const calendarsEl = document.getElementById('calendars');
const yearSelect = document.getElementById('yearSelect');
const locationSelect = document.getElementById('locationSelect');
const clearBtn = document.getElementById('clearBtn');
const totalHolidayInput = document.getElementById('totalHoliday');
const remainingEl = document.getElementById('remainingHoliday');
const selectedDatesUL = document.getElementById('selected-dates');
const exportBtn = document.getElementById('exportIcsBtn');

function buildYearOptions() {
  const currentYear = new Date().getFullYear();
  for (let i = 0; i <= 5; i++) {
    const y = currentYear + i;
    yearSelect.add(new Option(y, y));
  }
  yearSelect.value = currentYear;
}

function makeMonthCalendar(year, month) {
  const first = new Date(year, month, 1);
  const monthName = first.toLocaleString(undefined, { month: 'long' });

  const wrap = document.createElement('div');
  wrap.className = 'col-12 col-md-4';
  const card = document.createElement('div');
  card.className = 'calendar-month';

  const monname = document.createElement('div');
  monname.className = 'month-name';
  monname.textContent = `${monthName} ${year}`;
  card.appendChild(monname);

  const weekdays = document.createElement('div');
  weekdays.className = 'weekday-headers';
  ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(n => {
    const d = document.createElement('div');
    d.textContent = n;
    weekdays.appendChild(d);
  });
  card.appendChild(weekdays);

  const grid = document.createElement('div');
  grid.className = 'day-grid';
  let offset = (first.getDay() + 6) % 7; // Mon=0

  for (let i = 0; i < offset; i++) {
    grid.appendChild(document.createElement('div'), { className: 'day-cell disabled' });
  }

  let daysInMonth = new Date(year, month + 1, 0).getDate();
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const iso = toISODate(date);
    const cell = document.createElement('div');
    cell.className = 'day-cell';
    cell.dataset.date = iso;
    const dow = date.getDay();
    if (dow === 0 || dow === 6) cell.classList.add('weekend');
    if (publicHolidayDates.has(iso)) {
      cell.classList.add('holiday');
      cell.setAttribute('data-bs-toggle', 'tooltip');
      cell.setAttribute('title', publicHolidayDates.get(iso));
    }
    cell.textContent = d;
    cell.onclick = (ev) => handleDateClick(iso, ev.shiftKey);
    grid.appendChild(cell);
  }
  card.appendChild(grid);
  wrap.appendChild(card);
  return wrap;
}

function renderCalendars(year) {
  calendarsEl.innerHTML = '';
  for (let m = 0; m < 12; m++) {
    calendarsEl.appendChild(makeMonthCalendar(year, m));
  }

  refreshSelectionsUI();
  // enable tooltips
  [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].forEach(el => new bootstrap.Tooltip(el));
}

function handleDateClick(iso, shift) {
  if (shift && lastClickedDate) {
    let a = parseISODate(lastClickedDate),
    b = parseISODate(iso);
    if (a > b)[a, b] = [b, a];
    const range = [];
    for (let d = new Date(a); d <= b; d.setDate(d.getDate() + 1)) range.push(toISODate(d));
    const toggle = !selectedDates.has(iso);
    range.forEach(x => toggle ? selectedDates.add(x) : selectedDates.delete(x));
  } else {
    selectedDates.has(iso) ? selectedDates.delete(iso) : selectedDates.add(iso);
  }
  lastClickedDate = iso;
  refreshSelectionsUI();
  updateTotals();
}

function refreshSelectionsUI() {
  document.querySelectorAll('.day-cell').forEach(c => {
    if (c.dataset.date) c.classList.toggle('selected', selectedDates.has(c.dataset.date));
  });
  selectedDatesUL.innerHTML = '';

  if (selectedDates.size === 0) {
    const li = document.createElement('li');
    li.className = 'list-group-item';

    const spannone = document.createElement('span');
    spannone.textContent = 'None'

    const spantext = document.createElement('span');
    spantext.className = 'small-muted';
    spantext.textContent = 'Format: <date> (# days) (Holiday name)';

    li.appendChild(spannone);
    li.appendChild(document.createElement('br'));
    li.appendChild(document.createElement('br'));
    li.appendChild(spantext);

    selectedDatesUL.appendChild(li);
    return;
  }

  i = false;
  [...selectedDates].sort().forEach(iso => {
    const d = parseISODate(iso);
    const opts = {
      weekday: 'short',
      day: 'numeric',
      month: 'short',
      year: 'numeric'
    };
    let parts = d.toLocaleDateString(undefined, opts).split(' ');
    // Extract pieces: e.g. "Wed, 7 Sep 2025"
    const weekday = parts[0].replace(',', '');
    const day = d.getDate();
    const month = d.toLocaleString(undefined, {
      month: 'short'
    });
    const year = d.getFullYear();
    // Add ordinal suffix
    const suffix = (n) => {
      if (n >= 11 && n <= 13) return 'th';
      switch (n % 10) {
      case 1:
        return 'st';
      case 2:
        return 'nd';
      case 3:
        return 'rd';
      default:
        return 'th';
      }
    };
    const formatted = `${weekday}, ${day} ${suffix(day)} ${month} ${year}`;
    const li = document.createElement('li');
    li.className = 'list-group-item';
    if (i === true) {
      li.classList.add('list-group-item-secondary');
    }
    i = !i;
    const spantrash = document.createElement('span');
    spantrash.className = 'me-2 text-danger';
    spantrash.innerHTML = '<i class="bi bi-trash"></i>';
    spantrash.style.cursor = 'pointer';
    spantrash.onclick = () => {
      selectedDates.delete(iso);
      refreshSelectionsUI();
      updateTotals();
    };

    const spandate = document.createElement('span');
    spandate.className = 'me-2';
    spandate.textContent = formatted;

    if (publicHolidayDates.get(iso)) {
      cost = '0';
    } else if (weekday === "Sat" || weekday === "Sun") {
      cost = '0';
    } else if (weekday === "Fri") {
      cost = '½';
    } else {
      cost = '1';
    }

    const spancost = document.createElement('span');
    spancost.className = 'me-2';
    spancost.textContent = ' '+cost;

    li.appendChild(spantrash);
    li.appendChild(spandate);
    li.appendChild(spancost);

    if (publicHolidayDates.has(iso)) {
      const spanholiday = document.createElement('span');
      spanholiday.className = 'me-2';
      spanholiday.textContent = ' '+publicHolidayDates.get(iso);
      li.appendChild(spanholiday);
    }
    selectedDatesUL.appendChild(li);
  });
}

/* ------------------ Totals ------------------ */
function computeUsedMinutes() {
  let totalMinutes = 0;
  selectedDates.forEach(iso => {
    const date = parseISODate(iso);
    const dow = date.getDay(); // 0 Sun .. 6 Sat
    if (publicHolidayDates.has(iso) || dow === 0 || dow === 6) {
      // add 0
    } else if(dow >=1 && dow <=4) {
      totalMinutes += 7*60 + 45; // 465
    } else if(dow === 5) {
      totalMinutes += 3*60; // 180
    }
  });
  return totalMinutes;
}

function updateTotals() {
  const total = hhmmToMinutes(totalHolidayInput.value || '0:00');
  const used = computeUsedMinutes();
  const rem = total - used;
  remainingEl.textContent = minutesToHHMM(rem);
  remainingEl.classList.toggle('text-danger', rem < 0);
}

function exportICS() {
  if (selectedDates.size === 0) {
    alert('No dates selected.');
    return;
  }
  let lines = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//Holiday Planner//EN'];
  [...selectedDates].sort().forEach(iso => {
    lines.push('BEGIN:VEVENT');
    lines.push('UID:' + iso + '@holidayplanner');
    lines.push('DTSTAMP:' + new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z');
    lines.push('DTSTART;VALUE=DATE=' + iso.replace(/-/g, ''));
    lines.push('DTEND;VALUE=DATE=' + toISODate(new Date(parseISODate(iso).getTime() + 86400000)).replace(/-/g, ''));
    const summary = publicHolidayDates.has(iso) ? publicHolidayDates.get(iso) : 'Holiday';
    lines.push('SUMMARY:' + summary);
    lines.push('END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'holidays.ics';
  a.click();
  URL.revokeObjectURL(url);
}

async function init() {
  setTheme();
  buildYearOptions();
  // Fetch bank-holidays once, store globally
  publicHolidaysRawData = await fetchBankHolidays();

  // default year
  const year = parseInt(yearSelect.value, 10);
  setPublicHolidays(year);
  renderCalendars(year);
  updateTotals();

  locationSelect.onchange = () => {
    setPublicHolidays(yearSelect.value);
    setPublicHolidays(yearSelect.value);
    renderCalendars(yearSelect.value);
    updateTotals();
  }

  clearBtn.onclick = () => {
    selectedDates.clear();
    refreshSelectionsUI();
    updateTotals();
    return false;
  }

  yearSelect.onchange = () => {
    setPublicHolidays(yearSelect.value);
    renderCalendars(yearSelect.value);
    updateTotals();
  }
  totalHolidayInput.onchange = () => updateTotals();
  exportBtn.onclick = exportICS;
}

init();
</script>
</body>
</html>
