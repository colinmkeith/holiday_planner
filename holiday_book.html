<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Holiday Planner</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    body { padding: 20px; }
    .calendar-month { border-radius: .5rem; padding: 8px; margin-bottom: 12px; }
    .month-name { font-weight: 600; text-align: center; margin-bottom: 6px; }
    .day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .day-cell { padding: 6px; min-height: 40px; display:flex; align-items:flex-start; justify-content:center; cursor: pointer; border-radius:6px; user-select: none; }
    .day-cell.disabled { opacity: 0.45; cursor: default; }
    .day-cell .date-num { font-weight: 500; }
    .weekday-headers { display:grid; grid-template-columns: repeat(7, 1fr); font-size: 0.85rem; text-align:center; margin-bottom:4px; }
    .small-muted { font-size: .9rem; }
    .day-cell:not(.disabled):hover {
      background-color: rgba(13,110,253,0.15);
      transition: background-color 0.2s ease-in-out;
    }
    .day-cell:hover { cursor:pointer }
    #selected-dates { overflow:auto; padding-left: 1rem; }

    html[data-bs-theme="light"] body { background: #f8f9fa; }
    html[data-bs-theme="light"] .weekend { background: rgba(13,110,253,0.06); }
    html[data-bs-theme="light"] .calendar-month { border: 1px solid #dee2e6; background: #fff; }
    html[data-bs-theme="light"] .day-cell.selected { background: #0d6efd !important; color: white; }
    html[data-bs-theme="light"] .holiday { outline: 2px dashed #dc3545; }
    html[data-bs-theme="light"] .weekday-headers { color:#6c757d; }

    html[data-bs-theme="light"] .small-muted { color:#6c757d; }
    html[data-bs-theme="dark"] .weekend { background: rgba(13,50,120,0.5); }
    html[data-bs-theme="dark"] .holiday { outline: 2px dashed #dc3545; }
    html[data-bs-theme="dark"] .weekday-headers { color:#6c757d; }
    html[data-bs-theme="dark"] .day-cell.selected { background: #0d6efd !important; color: white; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row g-3">
      <!-- Left: calendars (3/4) -->
      <div class="col-lg-9">
        <div id="calendars" class="row g-3"></div>
      </div>

      <!-- Right: controls (1/4) -->
      <div class="col-lg-3">
        <div class="card">
          <div class="card-body">
            <label class="form-label" for="totalHoliday">Total holiday</label>
            <div class="input-group mb-3" id="totalHolidayWrapper">
              <input id="totalHoliday" class="form-control" type="text" placeholder="Hours left e.g. 80:00" value="" aria-label="Total holiday (HH:MM)">
              <span class="input-group-text">hours</span>
            </div>

            <label class="form-label">Year</label>
            <select id="yearSelect" class="form-select mb-3"></select>

            <label class="form-label">Location</label>
            <select id="locationSelect" class="form-select mb-3">
              <option selected="selected" value="england-and-wales">England and Wales</option>
              <option value="scotland">Scotland</option>
              <option value="northern-ireland">Northern Ireland</option>
            </select>

            <hr>

            <div class="mb-2">
              <h6 class="card-title">Remaining Holiday</h6>
              <div>
                <span id="remainingHoliday" class="fs-5">0:00</span>
                <span class="hours-suffix small-muted">hours</span>
              </div>
            </div>

            <hr>

            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="card-title mb-0">Selected Dates</h6>
              <button id="clearBtn" class="btn btn-sm btn-danger">Clear</button>
            </div>
            <ul id="selected-dates" class="list-group mb-0">
              <li class="list-group-item">None</li>
            </ul>

            <hr>
            <button id="exportIcsBtn" class="btn btn-sm btn-primary mb-3">Export ICS</button>

            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="themeToggle">
              <label class="form-check-label" for="themeToggle">Dark mode</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>
/*
  Holiday planner SPA
  - Fetches bank-holidays from https://www.gov.uk/bank-holidays.json and uses 'england-and-wales'
  - Draws 12 month calendars for selected year, 3 months per row
  - Click to toggle a date, Shift+click to range-select / range-unselect using last clicked
  - Calculates used hours:
      Mon-Thu: 7 hours 45 minutes (7.75h)
      Fri: 3 hours
      Sat/Sun or public holiday: 0 hours
  - Subtracts used hours from TotalHoliday (format H:MM or HH:MM)
  - Remaining displayed as H:MM with "hours" suffix, turns red if negative
*/

const GOV_BANK_HOLIDAYS_URL = 'https://www.gov.uk/bank-holidays.json';
let publicHolidaysRawData = new Map();
let publicHolidayDates = new Map(); // ISO -> holiday name
let selectedDates = new Set();
let defaultLocation = 'england-and-wales';
let lastClickedDate = null;

function setTheme() {
  document.documentElement.setAttribute('data-bs-theme', (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'))
  // initial theme: use saved preference if available, else system preference
  let savedTheme = localStorage.getItem('holidayPlannerTheme');
  if (savedTheme !== 'light' && savedTheme !== 'dark') {
    savedTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  let currentTheme = savedTheme;
  document.documentElement.setAttribute('data-bs-theme', currentTheme);

  // theme toggle control
  const themeToggle = document.getElementById('themeToggle');
  themeToggle.checked = (currentTheme === 'dark');
  themeToggle.addEventListener('change', () => {
    currentTheme = themeToggle.checked ? 'dark' : 'light';
    document.documentElement.setAttribute('data-bs-theme', currentTheme);
    localStorage.setItem('holidayPlannerTheme', currentTheme);
  });
}

/* ------------------ Utilities ------------------ */
function toISODate(d) {
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function parseISODate(iso) {
  const [y, m, d] = iso.split('-').map(Number);
  return new Date(y, m-1, d);
}

function minutesToHHMM(mins) {
  const sign = mins < 0 ? '-' : '';
  mins = Math.abs(Math.round(mins));
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return sign + String(h) + ':' + String(m).padStart(2,'0');
}

function hhmmToMinutes(hhmm) {
  if (!hhmm) return NaN;
  const parts = hhmm.trim().split(':');
  if(parts.length === 1) {
    const h = parseInt(parts[0], 10);
    if(Number.isNaN(h)) return NaN;
    return h*60;
  }
  if (parts.length !== 2) return NaN;
  const h = parseInt(parts[0], 10);
  const m = parseInt(parts[1], 10);
  if (Number.isNaN(h) || Number.isNaN(m)) return NaN;
  return h*60 + m;
}

/* ------------------ Fetch bank holidays ------------------ */
async function fetchBankHolidays() {
  try {
    const res = await fetch(GOV_BANK_HOLIDAYS_URL);
    if(!res.ok) throw new Error('fetch fail ' + res.status);
    const data = new Map(Object.entries(await res.json()));
    return data;
  } catch (err) {
    console.warn('Could not fetch bank holidays. Continuing without them.', err);
    return[];
  }
}

/* ------------------ Public holidays mapping ------------------ */
function setPublicHolidays(year) {
  const loc = locationSelect.value;

  if (!publicHolidaysRawData.has(loc)) {
    loc = defaultLocation
  }

  const events = publicHolidaysRawData.get(loc).events

  publicHolidayDates.clear();
  if(!Array.isArray(events)) return;
  events.forEach(e => {
    if (e.date && e.date.startsWith(String(year))) {
      publicHolidayDates.set(e.date, e.title);
    }
  });
}

/* ------------------ DOM refs ------------------ */
const calendarsEl = document.getElementById('calendars');
const yearSelect = document.getElementById('yearSelect');
const locationSelect = document.getElementById('locationSelect');
const clearBtn = document.getElementById('clearBtn');
const totalHolidayInput = document.getElementById('totalHoliday');
const remainingEl = document.getElementById('remainingHoliday');
const selectedDatesUL = document.getElementById('selected-dates');
const exportBtn = document.getElementById('exportIcsBtn');

/* ------------------ Calendar rendering ------------------ */
function buildYearOptions() {
  const now = new Date();
  const currentYear = now.getFullYear();
  yearSelect.innerHTML = '';
  for(let i=0;i<=5;i++){
    const y = currentYear + i;
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  }
  yearSelect.value = currentYear;
}

function clearCalendars() {
  calendarsEl.innerHTML = '';
}

function makeMonthCalendar(year, monthIndex) {
  const monthDate = new Date(year, monthIndex, 1);
  const monthName = monthDate.toLocaleString(undefined, { month: 'long' });

  const wrapper = document.createElement('div');
  wrapper.className = 'col-12 col-md-4';
  const card = document.createElement('div');
  card.className = 'calendar-month';

  const header = document.createElement('div');
  header.className = 'month-name';
  header.textContent = `${monthName} ${year}`;
  card.appendChild(header);

  const weekdayHeader = document.createElement('div');
  weekdayHeader.className = 'weekday-headers';
  const base = new Date(Date.UTC(2021, 7, 2)); // Monday
  for (let d = 0; d < 7; d++) {
    const dn = new Date(base);
    dn.setDate(base.getDate() + d);
    const el = document.createElement('div');
    el.textContent = dn.toLocaleString(undefined, { weekday: 'short' });
    weekdayHeader.appendChild(el);
  }
  card.appendChild(weekdayHeader);

  const grid = document.createElement('div');
  grid.className = 'day-grid';

  const firstDow = monthDate.getDay();
  const offset = (firstDow + 6) % 7;
  for(let i=0;i<offset;i++){
    const blank = document.createElement('div');
    blank.className = 'day-cell disabled';
    grid.appendChild(blank);
  }

  const daysInMonth = new Date(year, monthIndex+1, 0).getDate();
  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(year, monthIndex, d);
    const iso = toISODate(date);
    const cell = document.createElement('div');
    cell.className = 'day-cell';
    cell.dataset.date = iso;

    const dow = date.getDay();
    if (dow === 0 || dow === 6) cell.classList.add('weekend');
    if (publicHolidayDates.has(iso)) {
      cell.classList.add('holiday');
      cell.setAttribute('data-bs-toggle', 'tooltip');
      cell.setAttribute('title', publicHolidayDates.get(iso));
    }

    const num = document.createElement('div');
    num.className = 'date-num';
    num.textContent = d;
    cell.appendChild(num);

    cell.addEventListener('click', (ev) => {
      ev.preventDefault();
      if(cell.classList.contains('disabled')) return;
      handleDateClick(iso, ev.shiftKey);
    });

    grid.appendChild(cell);
  }

  card.appendChild(grid);
  wrapper.appendChild(card);
  return wrapper;
}

function renderCalendars(year) {
  clearCalendars();
  for (let m = 0; m < 12; m++) {
    calendarsEl.appendChild(makeMonthCalendar(year, m));
  }

  refreshSelectionsUI();

  // Enable bootstrap tooltips for any holiday cells
  [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].forEach(el => new bootstrap.Tooltip(el));
}

/* ------------------ Selection logic ------------------ */
function handleDateClick(isoDate, shiftKey) {
  if(shiftKey && lastClickedDate) {
    let a = parseISODate(lastClickedDate);
    let b = parseISODate(isoDate);
    if(a > b) [a,b] = [b,a];
    const clickedSelected = selectedDates.has(isoDate);
    const actionSelect = !clickedSelected;
    let cur = new Date(a);
    while(cur <= b){
      const iso = toISODate(cur);
      if(actionSelect) selectedDates.add(iso);
      else selectedDates.delete(iso);
      cur.setDate(cur.getDate() + 1);
    }
  } else {
    if(selectedDates.has(isoDate)) selectedDates.delete(isoDate);
    else selectedDates.add(isoDate);
  }
  lastClickedDate = isoDate;
  refreshSelectionsUI();
  updateTotals();
}

/* ------------------ UI refresh ------------------ */
function refreshSelectionsUI() {
  document.querySelectorAll('.day-cell').forEach(cell => {
    const iso = cell.dataset.date;
    if (!iso) return;
    if (selectedDates.has(iso)) {
      cell.classList.add('selected');
    } else {
      cell.classList.remove('selected');
    }

    if (publicHolidayDates.has(iso)) {
      cell.classList.add('holiday');
    } else {
      cell.classList.remove('holiday');
    }
  });
  selectedDatesUL.innerHTML = '';

  if (selectedDates.size === 0) {
    const li = document.createElement('li');
    li.className = 'list-group-item';

    const spannone = document.createElement('span');
    spannone.textContent = 'None'

    const spantext = document.createElement('span');
    spantext.className = 'small-muted';
    spantext.textContent = 'Format: <date> (# days) (Holiday name)';

    li.appendChild(spannone);
    li.appendChild(document.createElement('br'));
    li.appendChild(document.createElement('br'));
    li.appendChild(spantext);

    selectedDatesUL.appendChild(li);
    return;
  }

  i = false;
  [...selectedDates].sort().forEach(iso => {
    const d = parseISODate(iso);
    const opts = {
      weekday: 'short',
      day: 'numeric',
      month: 'short',
      year: 'numeric'
    };
    let parts = d.toLocaleDateString(undefined, opts).split(' ');
    // Extract pieces: e.g. "Wed, 7 Sep 2025"
    const weekday = parts[0].replace(',', '');
    const day = d.getDate();
    const month = d.toLocaleString(undefined, {
      month: 'short'
    });
    const year = d.getFullYear();
    // Add ordinal suffix
    const suffix = (n) => {
      if (n >= 11 && n <= 13) return 'th';
      switch (n % 10) {
      case 1:
        return 'st';
      case 2:
        return 'nd';
      case 3:
        return 'rd';
      default:
        return 'th';
      }
    };
    const formatted = `${weekday}, ${day} ${suffix(day)} ${month} ${year}`;
    const li = document.createElement('li');
    li.className = 'list-group-item';
    if (i === true) {
      li.classList.add('list-group-item-secondary');
    }
    i = !i;
    const spantrash = document.createElement('span');
    spantrash.className = 'me-2 text-danger';
    spantrash.innerHTML = '<i class="bi bi-trash"></i>';
    spantrash.style.cursor = 'pointer';
    spantrash.onclick = () => {
      selectedDates.delete(iso);
      refreshSelectionsUI();
      updateTotals();
    };

    const spandate = document.createElement('span');
    spandate.className = 'me-2';
    spandate.textContent = formatted;

    if (publicHolidayDates.get(iso)) {
      cost = '0';
    } else if (weekday === "Sat" || weekday === "Sun") {
      cost = '0';
    } else if (weekday === "Fri") {
      cost = '½';
    } else {
      cost = '1';
    }

    const spancost = document.createElement('span');
    spancost.className = 'me-2';
    spancost.textContent = ' '+cost;

    li.appendChild(spantrash);
    li.appendChild(spandate);
    li.appendChild(spancost);

    if (publicHolidayDates.has(iso)) {
      const spanholiday = document.createElement('span');
      spanholiday.className = 'me-2';
      spanholiday.textContent = ' '+publicHolidayDates.get(iso);
      li.appendChild(spanholiday);
    }
    selectedDatesUL.appendChild(li);
  });
}

/* ------------------ Totals ------------------ */
function computeUsedMinutes() {
  let totalMinutes = 0;
  selectedDates.forEach(iso => {
    const date = parseISODate(iso);
    const dow = date.getDay(); // 0 Sun .. 6 Sat
    if (publicHolidayDates.has(iso) || dow === 0 || dow === 6) {
      // add 0
    } else if(dow >=1 && dow <=4) {
      totalMinutes += 7*60 + 45; // 465
    } else if(dow === 5) {
      totalMinutes += 3*60; // 180
    }
  });
  return totalMinutes;
}

function updateTotals() {
  // parse totalHoliday input as minutes
  const totalInput = totalHolidayInput.value.trim();
  const totalMinutes = hhmmToMinutes(totalInput);
  const usedMinutes = computeUsedMinutes();
  if(Number.isNaN(totalMinutes)) {
    remainingEl.textContent = 'Invalid';
    remainingEl.classList.add('text-danger');
  } else {
    const remaining = totalMinutes - usedMinutes;
    remainingEl.textContent = minutesToHHMM(remaining);
    if(remaining < 0) remainingEl.classList.add('text-danger');
    else remainingEl.classList.remove('text-danger');
  }
}

/* ------------------ ICS export ------------------ */
function exportICS() {
  if (selectedDates.size === 0) {
    alert('No dates selected.');
    return;
  }

  const lines = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//Holiday Planner//EN'
  ];
  [...selectedDates].sort().forEach(iso => {
    const next = new Date(parseISODate(iso).getTime() + 24*60*60*1000);
    lines.push('BEGIN:VEVENT');
    lines.push('UID:' + iso + '@holidayplanner');
    lines.push('DTSTAMP:' + new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z');
    // DTSTART is whole day; DTEND should be next day
    lines.push('DTSTART;VALUE=DATE:' + iso.replace(/-/g,''));
    lines.push('DTEND;VALUE=DATE:' + toISODate(next).replace(/-/g,''));
    // include holiday name if present
    const summary = publicHolidayDates.has(iso) ? publicHolidayDates.get(iso) : 'Holiday';
    lines.push('SUMMARY:' + summary);
    lines.push('END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'holidays.ics';
  document.body.appendChild(a); // ??
  a.click();
  a.remove(); // ??
  URL.revokeObjectURL(url);
}

/* ------------------ Controls & events ------------------ */
function attachControls() {
  yearSelect.addEventListener('change', () => {
    const year = parseInt(yearSelect.value, 10);
    // Re-apply public holidays for new year (we stored events globally)
    setPublicHolidays(year);
    renderCalendars(year);
    updateTotals();
  });

  totalHolidayInput.addEventListener('input', () => {
    // if user types just a number, convert to X:00 on blur; but for now update totals live
    updateTotals();
  });

  // On window resize or scroll, reposition arrow if visible
  window.addEventListener('resize', () => {
    if(arrowEl.classList.contains('visible')) showArrowPointingAtInput();
  });
  window.addEventListener('scroll', () => {
    if(arrowEl.classList.contains('visible')) showArrowPointingAtInput();
  });

  exportBtn.addEventListener('click', exportICS);
}

/* ------------------ Initialization ------------------ */
async function init() {
  setTheme();
  buildYearOptions();
  attachControls();
  // Fetch bank-holidays once, store globally
  publicHolidaysRawData = await fetchBankHolidays();

  // default year
  const year = parseInt(yearSelect.value, 10);
  setPublicHolidays(year);
  renderCalendars(year);
  updateTotals();

  locationSelect.onchange = () => {
    setPublicHolidays(yearSelect.value);
    setPublicHolidays(yearSelect.value);
    renderCalendars(yearSelect.value);
    updateTotals();
  }

  clearBtn.onclick = () => {
    selectedDates.clear();
    refreshSelectionsUI();
    updateTotals();
    return false;
  }

  yearSelect.onchange = () => {
    setPublicHolidays(yearSelect.value);
    renderCalendars(yearSelect.value);
    updateTotals();
  }
  totalHolidayInput.onchange = () => updateTotals();
  exportBtn.onclick = exportICS;
}

init();
</script>
</body>
</html>
