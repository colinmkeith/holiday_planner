<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Holiday Planner</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    body { padding: 20px; }
    .calendar-month { border-radius: .5rem; padding: 8px; margin-bottom: 12px; }
    .month-name { font-weight: 600; text-align: center; margin-bottom: 6px; }
    .day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .day-cell { padding: 6px; min-height: 40px; display:flex; align-items:flex-start; justify-content:center; cursor: pointer; border-radius:6px; user-select: none; }
    .day-cell.disabled { opacity: 0.45; }
    .day-cell.historical, .day-cell.today { opacity: 0.2; }
    .day-cell .date-num { font-weight: 500; }
    .weekday-headers { display:grid; grid-template-columns: repeat(7, 1fr); font-size: 0.85rem; text-align:center; margin-bottom:4px; }
    .small-muted { font-size: .9rem; }
    .day-cell:not(.disabled):not(.today):hover {
      background-color: rgba(13,110,253,0.15);
      transition: background-color 0.2s ease-in-out;
    }
    .day-cell:hover { cursor:pointer }
    .day-cell.disabled:hover { opacity: 0.45; cursor: default; }
    .day-cell.historical:hover, .day-cell.today:hover { cursor:not-allowed; }
    .day-cell.selected.weekend { opacity: 0.5; }
    .day-cell.selected.prebooked { opacity: 0.5; }

    #selected-dates .date { display: inline-block; width: 17ch; }
    #selected-dates .cost { display: inline-block; width: 7ch; }
    #selected-dates .holiday, #selected-dates .weekend, #selected-dates .otherday { display:inline-block; padding: 2px; }

    .delete { cursor: pointer; }

    @media (min-width: 1000px) {
      .sidebar > .card {
        position: fixed;
        top: 0;
        right: 0;
        width: 25%; /* keep roughly the same width */
        max-height: 100vh; 
        overflow-y: auto; /* allow scroll inside if too tall */
      }
    }

    #nav-tab-dates { margin-bottom: -1px }
    .tab-pane { padding: 5px; }
    .tab-pane.border { border-top: 0; }

    /* Colours */
    .weekday-headers { color:#6c757d; }
    .holiday:not(.otherday) { outline: 2px dashed #dc3545; }
    .otherday:not(.holiday) { outline: 2px dashed #6dbb4e; }
    .holiday.otherday { outline: 2px dashed #FFBF00; }
    .today { outline: 2px dashed #FFEA00; }

    html[data-bs-theme="light"] body { background: #f8f9fa; }
    html[data-bs-theme="light"] .calendar-month { border: 1px solid #dee2e6; background: #fff; }
    html[data-bs-theme="light"] .small-muted { color:#6c757d; }
    html[data-bs-theme="light"] .weekend { background: rgba(13,110,253,0.06); }
    html[data-bs-theme="light"] #selected-dates .weekend { outline: 2px dashed rgba(13,110,253,0.06); }
    html[data-bs-theme="light"] .day-cell.selected { color: white; }

    html[data-bs-theme="dark"] .weekend { background: rgba(13,50,120,0.5); }
    html[data-bs-theme="dark"] #selected-dates .weekend { outline: 2px dashed rgba(13,50,120,0.5); }

    .day-cell.selected:not(.halfday):not(.friday):not(.holiday):not(.otherday) { background: repeating-linear-gradient(45deg, #606dbc, #606dbc 4px, #465298 4px, #465298 8px); }

    .day-cell.selected.halfday:not(.holiday):not(.otherday), .day-cell.selected.friday:not(.holiday):not(.otherday) {
      background: repeating-linear-gradient(45deg, #606dbc, #606dbc 25%, #465298 50%);
    }

    .day-cell.selected.holiday { background: repeating-linear-gradient(45deg, #dc3545, #dc3545 4px, #ac0515 4px, #ac0515 8px); }
    .day-cell.selected.otherday { background: repeating-linear-gradient(45deg, #6dbb4e, #6dbb4e 4px, #2d7b1e 4px, #2d7b1e 8px); }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row g-3">
      <!-- Left: calendars (3/4) -->
      <div class="col-lg-9">
        <div id="calendars" class="row g-3"></div>
      </div>

      <!-- Right: controls (1/4) -->
      <div class="sidebar col-lg-3">
        <div class="card">
          <div class="card-body">
            <label class="form-label" for="totalHoliday">Total holiday</label>
            <div class="input-group mb-3 was-validated" id="totalHolidayWrapper">
              <input id="totalHoliday" class="form-control needs-validation" type="text" placeholder="Hours left e.g. 80:00" value="" aria-label="Total holiday (HH:MM)" required pattern="^[0-9]+(:[0-9][0-9])?$">
              <span class="input-group-text">hours</span>
            </div>

            <label class="form-label">Year</label>
            <select id="yearSelect" class="form-select mb-3"></select>

            <label class="form-label">Location</label>
            <select id="locationSelect" class="form-select mb-3">
              <option selected="selected" value="england-and-wales">England and Wales</option>
              <option value="scotland">Scotland</option>
              <option value="northern-ireland">Northern Ireland</option>
            </select>

            <hr>

            <div class="mb-2">
              <h6 class="card-title">Remaining Holiday</h6>
              <div>
                <span id="remainingHoliday" class="fs-5">0:00</span>
                <span class="hours-suffix small-muted">hours</span>
              </div>
            </div>

            <hr>

            <nav>
              <div class="nav nav-tabs" id="nav-tab-dates" role="tablist">
                <button class="nav-link active" id="nav-select-dates-tab" data-bs-toggle="tab" data-bs-target="#nav-select-dates" type="button" role="tab" aria-controls="nav-select-dates" aria-selected="true">Selected Dates</button>
                <button class="nav-link" id="nav-other-dates-tab" data-bs-toggle="tab" data-bs-target="#nav-other-dates" type="button" role="tab" aria-controls="nav-other-dates" aria-selected="false">Other Dates</button>
                <button class="nav-link" id="nav-help-tab" data-bs-toggle="tab" data-bs-target="#nav-help" type="button" role="tab" aria-controls="nav-help" aria-selected="false">Help</button>
              </div>
            </nav>

            <div class="tab-content" id="nav-tabContent">
              <div class="tab-pane fade show active border" id="nav-select-dates" role="tabpanel" aria-labelledby="nav-select-dates-tab" tabindex="0">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="card-title mb-2">Your selected dates.</h6>
                  <button id="clearBtn" class="btn btn-sm btn-danger" aria-label="Clear selected dates">Clear</button>
                </div>

                <ul id="selected-dates" class="list-group mb-0" aria-live="polite">
                  <li class="list-group-item" role="listitem">None</li>
                </ul>
              </div>

              <div class="tab-pane fade border" id="nav-other-dates" role="tabpanel" aria-labelledby="nav-other-dates-tab" tabindex="1">
                <h6 class="card-title mb-2">Your other dates. (Format YYYY-MM-DD,Label[,booked]</h6>
                <textarea class="form-control" id="otherdates" placeholder="Format: YYYY-MM-DD,Label[,Booked]" spellcheck=true></textarea>
              </div>

              <div class="tab-pane fade show border" id="nav-help" role="tabpanel" aria-labelledby="nav-help-tab" tabindex="0">
                <h6 class="card-title mb-2">Help</h6>
                <div>
                  <ul>
                    <li>Enter your remaining hours of holiday.</li>
                    <li>Click to select days</li>
                    <li>Mon-Thu are worth <b>7hrs 45mins</b></li>
                    <li>Fri are worth <b>3hrs</b></li>
                    <li>Sat, Sun, and Bank Holidays are worth <b>0hrs</b></li>
                    <li>Shift-Click to select range of days</li>
                    <li>Ctrl-Click to select half-days (Mon-Thu)</li>
                    <li>Ctrl-Shift-Click to select a range, select Mon-Thu as half-days</li>
                    <li>Input personal dates, e.g. birthdays, holidays in Other dates to highlight</li>
                  </ul>
                </div>

                <hr>
                <div>
                  <h6 class="card-title">TODO</h6>
                  <ul>
                    <li>Input already booked off days to highlight without deducting. E.g. zero-day holidays</li>
                  </ul>
                </div>
              </div>
            </div>

            <hr>
            <button id="exportIcsBtn" class="btn btn-sm btn-primary mb-3">Export ICS</button>

            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="themeToggle">
              <label class="form-check-label" for="themeToggle">Dark mode</label>
            </div>

            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" checked="checked" id="historyToggle">
              <label class="form-check-label" for="historyToggle">Block Historical Dates</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>
/*
  Holiday planner SPA
  - Fetches bank-holidays from https://www.gov.uk/bank-holidays.json and uses 'england-and-wales'
  - Draws 12 month calendars for selected year, 3 months per row
  - Click to toggle a date, Shift+click to range-select / range-unselect using last clicked
  - Calculates used hours:
      Mon-Thu: 7 hours 45 minutes (7.75h)
      Fri: 3 hours
      Sat/Sun or public holiday: 0 hours
  - Subtracts used hours from TotalHoliday (format H:MM or HH:MM)
  - Remaining displayed as H:MM with "hours" suffix, turns red if negative
*/

const GOV_BANK_HOLIDAYS_URL = 'https://www.gov.uk/bank-holidays.json';
let publicHolidaysRawData = new Map();
let publicHolidayDates = new Map(); // ISO -> holiday name
let otherHolidayDates = new Map(); // ISO -> holiday name
let prebookedDates = new Set();
let selectedDates = new Set();
let halfDays = new Set();
let defaultLocation = 'england-and-wales';
let lastNormalClickedDate = null;

function setTheme() {
  const theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';

  // initial theme: use saved preference if available, else system preference
  let savedTheme = localStorage.getItem('holidayPlannerTheme');
  if (savedTheme !== 'light' && savedTheme !== 'dark') {
    savedTheme = theme;
  }
  let currentTheme = savedTheme;
  document.documentElement.setAttribute('data-bs-theme', currentTheme);

  // theme toggle control
  themeToggle.checked = (currentTheme === 'dark');
}

/* ------------------ Utilities ------------------ */
function parseISODate(iso) {
  const [y, m, d] = iso.split('-').map(Number);
  return new Date(y, m-1, d);
}

function minutesToHHMM(mins) {
  const sign = mins < 0 ? '-' : '';
  mins = Math.abs(Math.round(mins));
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return sign + String(h) + ':' + String(m).padStart(2,'0');
}

function hhmmToMinutes(hhmm) {
  if (!hhmm) return NaN;
  const parts = hhmm.trim().split(':');
  if(parts.length === 1) {
    const h = parseInt(parts[0], 10);
    if(Number.isNaN(h)) return NaN;
    return h*60;
  }
  if (parts.length !== 2) return NaN;
  const h = parseInt(parts[0], 10);
  const m = parseInt(parts[1], 10);
  if (Number.isNaN(h) || Number.isNaN(m)) return NaN;
  return h*60 + m;
}

function formatDateISO(d) {
  // Always returns YYYY-MM-DD
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function formatDateISO(d) {
  // Always returns YYYY-MM-DD
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}



function formatDateLong(d) {
  // Example output: "Tue, 23rd Sep 2025"
  const weekday = d.toLocaleDateString(undefined, { weekday: 'short' });
  const day = d.getDate();
  const month = d.toLocaleString(undefined, { month: 'short' });
  const year = d.getFullYear();

  // Ordinal suffix
  const suffix = (n) => {
    if (n >= 11 && n <= 13) return 'th';
    switch (n % 10) {
      case 1: return 'st';
      case 2: return 'nd';
      case 3: return 'rd';
      default: return 'th';
    }
  };

  return `${weekday}, ${day}${suffix(day)} ${month} ${year}`;
}

function rebuildTooltips() {
  [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].forEach(el => {
    if (bootstrap.Tooltip.getInstance(el)) {
      bootstrap.Tooltip.getInstance(el).dispose();
    }

    new bootstrap.Tooltip(el);
  });
}

/* ------------------ Fetch bank holidays ------------------ */
async function fetchBankHolidays() {
  try {
    const res = await fetch(GOV_BANK_HOLIDAYS_URL);
    if(!res.ok) throw new Error('fetch fail ' + res.status);
    const data = new Map(Object.entries(await res.json()));
    return data;
  } catch (err) {
    console.warn('Could not fetch bank holidays. Continuing without them.', err);
    return[];
  }
}

/* ------------------ Public holidays mapping ------------------ */
function setPublicHolidays(year) {
  const loc = locationSelect.value;

  if (!publicHolidaysRawData.has(loc)) {
    loc = defaultLocation
  }

  const events = publicHolidaysRawData.get(loc).events

  publicHolidayDates.clear();
  if(!Array.isArray(events)) return;
  events.forEach(e => {
    if (e.date && e.date.startsWith(String(year))) {
      publicHolidayDates.set(e.date, e.title);
    }
  });
}

/* ------------------ DOM refs ------------------ */
const calendarsEl = document.getElementById('calendars');
const yearSelect = document.getElementById('yearSelect');
const locationSelect = document.getElementById('locationSelect');
const clearBtn = document.getElementById('clearBtn');
const totalHolidayInput = document.getElementById('totalHoliday');
const remainingEl = document.getElementById('remainingHoliday');
const selectedDatesUL = document.getElementById('selected-dates');
const exportBtn = document.getElementById('exportIcsBtn');
const historyToggle = document.getElementById('historyToggle');
const themeToggle = document.getElementById('themeToggle');
const otherTab = document.getElementById('nav-other-dates-tab');
const othersEl = document.getElementById('otherdates');

/* ------------------ Calendar rendering ------------------ */
function buildYearOptions() {
  const now = new Date();
  const currentYear = now.getFullYear();
  yearSelect.innerHTML = '';
  for(let i=0;i<=5;i++){
    const y = currentYear + i;
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  }
  yearSelect.value = currentYear;
}

function clearCalendars() {
  calendarsEl.innerHTML = '';
  today = false;
}

function makeMonthCalendar(year, monthIndex) {
  const monthDate = new Date(year, monthIndex, 1);
  const monthName = monthDate.toLocaleString(undefined, { month: 'long' });

  const now = new Date();

  const wrapper = document.createElement('div');
  wrapper.className = 'col-12 col-md-4';
  const card = document.createElement('div');
  card.className = 'calendar-month';

  const header = document.createElement('div');
  header.className = 'month-name';
  header.textContent = `${monthName} ${year}`;
  card.appendChild(header);

  const weekdayHeader = document.createElement('div');
  weekdayHeader.className = 'weekday-headers';
  const base = new Date(Date.UTC(2021, 7, 2)); // Monday
  for (let d = 0; d < 7; d++) {
    const dn = new Date(base);
    dn.setDate(base.getDate() + d);
    const el = document.createElement('div');
    el.textContent = dn.toLocaleString(undefined, { weekday: 'short' });
    weekdayHeader.appendChild(el);
  }
  card.appendChild(weekdayHeader);

  const grid = document.createElement('div');
  grid.className = 'day-grid';
  grid.setAttribute('role', 'grid');

  const firstDow = monthDate.getDay();
  const offset = (firstDow + 6) % 7;
  for(let i=0;i<offset;i++){
    const blank = document.createElement('div');
    blank.className = 'day-cell disabled';
    blank.setAttribute('role', 'gridcell');
    grid.appendChild(blank);
  }

  const daysInMonth = new Date(year, monthIndex+1, 0).getDate();
  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(year, monthIndex, d);
    const yyyy = year;
    const mm   = new String(monthIndex+1).padStart(2, '0');
    const dd   = new String(d).padStart(2, '0');
    const iso = `${yyyy}-${mm}-${dd}`;
    const cell = document.createElement('div');

    cell.className = 'day-cell';
    cell.dataset.date = iso;
    cell.setAttribute('role', 'gridcell');

    const num = document.createElement('div');
    num.className = 'date-num';
    num.textContent = d;
    cell.appendChild(num);
    cell.addEventListener('click', (ev) => {
      ev.preventDefault();
      handleDateClick(iso, ev);
    });

    grid.appendChild(cell);
  }

  card.appendChild(grid);
  wrapper.appendChild(card);
  return wrapper;
}

function renderCalendars(year) {
  clearCalendars();
  for (let m = 0; m < 12; m++) {
    calendarsEl.appendChild(makeMonthCalendar(year, m));
  }

  refreshSelectionsUI();

  // Enable bootstrap tooltips for any holiday cells
  rebuildTooltips();
  if(today !== false) {
    today.scrollIntoView();
  }
}

/* ------------------ Selection logic ------------------ */
function handleDateClick(isoDate, ev) {
  const ctrlKey = ev.ctrlKey;
  const shiftKey = ev.shiftKey;
  const isCurrentlySelected = selectedDates.has(isoDate);
  const cell = ev.target.classList.contains('date-num') ? ev.target.parentNode : ev.target;

  if(cell.classList.contains('disabled') || cell.classList.contains('historical')) return;

  let clickDate = parseISODate(isoDate);

  if(shiftKey && lastNormalClickedDate) {
    let lastDate = parseISODate(lastNormalClickedDate);
    if(lastDate > clickDate) {
      [lastDate, clickDate] = [clickDate, lastDate];
    }

    let curDate = new Date(lastDate);

    while(curDate <= clickDate){
      const isoDate = formatDateISO(curDate);
      selectLogic(isoDate, isCurrentlySelected, ctrlKey);
      curDate.setDate(curDate.getDate() + 1);
    }
  } else {
    selectLogic(isoDate, isCurrentlySelected, ctrlKey);
  }

  lastNormalClickedDate = isoDate;
  refreshSelectionsUI();
  updateTotals();
}

function selectLogic(isoDate, isCurrentlySelected, ctrlKey) {
  const clickDate = parseISODate(isoDate);
  const dow = clickDate.getDay(); // 0 Sun .. 6 Sat (Fri === 5)
  const isCurrentlyHalfDay = halfDays.has(isoDate);

  // If currently selected, unselect.
  if(isCurrentlySelected) {
    // If Ctrl pressed and not a half day, select as half day, else unselect
    if (ctrlKey) {
      if(isCurrentlyHalfDay) {
        halfDays.delete(isoDate);
      } else {
        halfDays.add(isoDate);
      }
      selectedDates.add(isoDate);
    } else {
      selectedDates.delete(isoDate);
      halfDays.delete(isoDate);
    }
  }
  // Else select, unless ctrl is pressed in which case select as half day
  else {
    // If Ctrl pressed and not a half day, select as half day
    if (ctrlKey && !isCurrentlyHalfDay) {
      halfDays.add(isoDate);
    }
    selectedDates.add(isoDate);
  }
}

/* ------------------ UI refresh ------------------ */
function refreshSelectionsUI() {
  const now = new Date();
  now.setHours(0, 0, 0, 0);

  document.querySelectorAll('.day-cell').forEach(cell => {
    const iso = cell.dataset.date;

    if (!iso) return;

    const date = parseISODate(iso);
    date.setHours(0, 0, 0, 0);
    const dow = date.getDay(); // 0 Sun .. 6 Sat (Fri === 5)

    let arialabel = parseISODate(iso).toString().split(' 00')[0];

    if (selectedDates.has(iso)) {
      cell.classList.add('selected');
    } else {
      cell.classList.remove('selected');
    }

    if (prebookedDates.has(iso)) {
      cell.classList.add('prebooked');
    } else {
      cell.classList.remove('prebooked');
    }

    // If historicalToggle not checked then don't treat as historical
    const historical = historyToggle.checked ? date < now : false;
    if (historical) {
      cell.classList.add('historical');
      arialabel += ' historical date so not selectable.';
    }

    if (date.getTime() == now.getTime()) {
      cell.classList.add('today');
      cell.setAttribute('data-bs-toggle', 'tooltip');
      const title = cell.getAttribute('title') || '';
      cell.setAttribute('title', (title ? title + '. ' : '') + 'Today');
      arialabel += " Today's date.";
      cell.setAttribute('aria-current', 'date');
    }

    if (dow === 0 || dow === 6) {
      cell.classList.add('weekend');
      arialabel += " Is a weekend day.";
    }

    if (publicHolidayDates.has(iso)) {
      cell.classList.add('holiday');
      cell.setAttribute('data-bs-toggle', 'tooltip');
      const title = cell.getAttribute('title') || '';
      cell.setAttribute('title', (title ? title + '. ' : '') + (historical ? 'Was ' : '') + publicHolidayDates.get(iso));
      arialabel += ' Is a public holiday ('+ publicHolidayDates.get(iso) + ')';
    } else {
      cell.classList.remove('holiday');
    }

    if (otherHolidayDates.has(iso)) {
      cell.classList.add('otherday');
      cell.setAttribute('data-bs-toggle', 'tooltip');
      const title = cell.getAttribute('title') || '';
      cell.setAttribute('title', (title ? title + '. ' : '') + (historical ? 'Was ' : '') + otherHolidayDates.get(iso));
      arialabel += ' Is a personal date ('+ otherHolidayDates.get(iso) + ')';
    } else {
      cell.classList.remove('otherday');
    }

    cell.setAttribute('arialabel', arialabel);

    if (halfDays.has(iso)) {
      cell.classList.add('halfday');
    } else {
      cell.classList.remove('halfday');
    }

    if (prebookedDates.has(iso)) {
      cell.setAttribute('data-bs-toggle', 'tooltip');
      const title = cell.getAttribute('title') || '';
      cell.setAttribute('title', (title ? title + '. ' : '') + ' Already booked');
      arialabel += ' Already booked.'
      cell.classList.add('prebooked');
    }

    // Friday
    if (dow === 5) {
      cell.classList.add('friday');
    } else {
      cell.classList.remove('friday');
    }
  });
  selectedDatesUL.innerHTML = '';

  if (selectedDates.size === 0) {
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.setAttribute('role', 'listitem');

    const spannone = document.createElement('span');
    spannone.textContent = 'None'
    li.appendChild(spannone);

    selectedDatesUL.appendChild(li);
    return;
  }

  i = false;
  [...selectedDates].sort().forEach(iso => {
    const d = parseISODate(iso);
    const formatted = formatDateLong(d);
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.setAttribute('role', 'listitem');
    if (i === true) {
      li.classList.add('list-group-item-secondary');
    }
    i = !i;

    const trashicon = document.createElement('i');
    trashicon.className = 'bi bi-trash';
    trashicon.setAttribute('data-bs-toggle', 'tooltip');
    trashicon.setAttribute('title', 'Delete date');

    const spantrash = document.createElement('span');
    spantrash.className = 'me-2 text-danger delete';
    spantrash.appendChild(trashicon);
    spantrash.setAttribute('aria-label', `Remove ${formatted}`);

    spantrash.onclick = () => {
      selectedDates.delete(iso);
      refreshSelectionsUI();
      updateTotals();
    };

    const spandate = document.createElement('span');
    spandate.className = 'me-1 date';
    spandate.textContent = formatted;

    const weekday = formatted.split(', ')[0];
    const cost = getHolidayCost(iso);

    let costLabel;
    switch (cost) {
      case 0:
        costLabel = '0 days';
        break;
      case 0.5:
        costLabel = '½ day';
        break;
      default:
        costLabel = cost + ' day';
        break;
    }

    const spancost = document.createElement('span');
    spancost.className = 'me-1 cost';
    spancost.textContent = `(${costLabel})`;

    li.appendChild(spantrash);
    li.appendChild(spandate);
    li.appendChild(spancost);

    let text = publicHolidayDates.get(iso);
    if (otherHolidayDates.has(iso)) {
      text = (text ? text +', ' : '') + otherHolidayDates.get(iso);
    }

    const spanlabel = document.createElement('span');
    if (text) {

      if (publicHolidayDates.has(iso))
        spanlabel.classList.add('holiday');

      if (otherHolidayDates.has(iso))
        spanlabel.classList.add('otherday');

      spanlabel.textContent = text;
    }
    else if (weekday === "Sat" || weekday === "Sun") {
      spanlabel.classList.add('weekend');
      spanlabel.textContent = 'Weekend';
    }

    if (spanlabel.textContent !== '')
      li.appendChild(spanlabel);

    selectedDatesUL.appendChild(li);
  });
  rebuildTooltips();
}

/* ------------------ Totals ------------------ */
function getHolidayCost(iso) {
  const date = parseISODate(iso);
  const dow = date.getDay(); // 0 Sun .. 6 Sat

  if (publicHolidayDates.has(iso) || dow === 0 || dow === 6 || prebookedDates.has(iso)) {
    return 0;
  }

  if (dow === 5) {
    return 0.5;
  }

  if (halfDays.has(iso)) {
    return 0.5;
  }

  return 1;
}

function computeUsedMinutes() {
  let totalMinutes = 0;
  selectedDates.forEach(iso => {
    const cost = getHolidayCost(iso);
    if (cost === 1) totalMinutes += 7*60 + 45;
    else if (cost === 0.5) totalMinutes += 3*60;
    // cost 0 → no minutes added
  });
  return totalMinutes;
}

function updateTotals() {
  // parse totalHoliday input as minutes
  const totalInput = totalHolidayInput.value.trim();
  const totalMinutes = hhmmToMinutes(totalInput);
  const usedMinutes = computeUsedMinutes();
  if(Number.isNaN(totalMinutes)) {
    remainingEl.textContent = 'NaN';
    remainingEl.classList.add('text-danger');
  } else {
    const remaining = totalMinutes - usedMinutes;
    remainingEl.textContent = minutesToHHMM(remaining);
    if(remaining < 0) remainingEl.classList.add('text-danger');
    else remainingEl.classList.remove('text-danger');
  }
}

/* ------------------ ICS export ------------------ */
function exportICS() {
  if (selectedDates.size === 0) {
    alert('No dates selected.');
    return;
  }

  const lines = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//Holiday Planner//EN'
  ];
  [...selectedDates].sort().forEach(iso => {
    const next = new Date(parseISODate(iso).getTime() + 24*60*60*1000);
    lines.push('BEGIN:VEVENT');
    lines.push('UID:' + iso + '@holidayplanner');
    lines.push('DTSTAMP:' + new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z');
    // DTSTART is whole day; DTEND should be next day
    lines.push('DTSTART;VALUE=DATE:' + iso.replace(/-/g,''));
    lines.push('DTEND;VALUE=DATE:' + formatDateISO(next).replace(/-/g,''));
    // include holiday name if present
    let summary = publicHolidayDates.has(iso) ? publicHolidayDates.get(iso) : 'Holiday';
    let otherholidayreason = otherHolidayDates.get(iso);
    if (otherholidayreason)
      summary += ' and your event ' + otherholidayreason;
    if(prebookedDates.get(iso)) {
      if (otherholidayreason)
        summary += '. ';
      summary += 'Which you have already booked off.';
    }
    lines.push('SUMMARY:' + summary);
    lines.push('END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'holidays.ics';
  document.body.appendChild(a); // ??
  a.click();
  a.remove(); // ??
  URL.revokeObjectURL(url);
}

/* ------------------ Controls & events ------------------ */
function attachControls() {
  yearSelect.addEventListener('change', () => {
    changeInInputs();
  });

  locationSelect.addEventListener('change', () => {
    changeInInputs();
  });

  clearBtn.addEventListener('click', () => {
    selectedDates.clear();
    halfDays.clear();
    changeInInputs();
  });

  exportBtn.addEventListener('click', () => {
    exportICS();
  });

  totalHolidayInput.addEventListener('input', (ev) => {
    // if user types just a number, convert to X:00 on blur; but for now update totals live
    updateTotals();
    if(!ev.target.checkValidity()) {
      ev.target.classList.add('was-validated');
    }
  });
  totalHolidayInput.checkValidity();

  othersEl.addEventListener('input', (ev) => {
    otherHolidayDates.clear();
    processOtherHolidayDates();
    changeInInputs();
  });

  historyToggle.addEventListener('change', () => {
    changeInInputs();
  });

  themeToggle.addEventListener('change', () => {
    currentTheme = themeToggle.checked ? 'dark' : 'light';
    document.documentElement.setAttribute('data-bs-theme', currentTheme);
    localStorage.setItem('holidayPlannerTheme', currentTheme);
  });
}

function processOtherHolidayDates() {
  [...othersEl.value.split('\n')].forEach(line => {
    line = line.replace(/#.*$/, '')
               .replace(/\s+$/, '')
               .replace(/^\s+/, '');
    if (!line) return;

    const res = line.match(/^([0-9]{4}-[0-9]{1,2}-[0-9]{1,2}),(.*)$/);

    if (res === null)
      return;

    if (typeof(res) === 'object' && res[1] && res[2]) {
      if (res[2] = res[2].replace(/,(?:1|booked)$/, '')) {
        res[3] = 1;
      }
      let [undef, date, line, prebooked] = res;

      const [yy, mm, dd] = date.split('-');
      date = `${yy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`;
      const d = new Date();

      // Silently ignore years in the past because can't put that on a calendar
      if (yy < d.getFullYear())
        return;

      const label = res[2].replace(/^"(.+)"$/, '$1') /* CSV */
                          .replace(/^\s+/, '')
                          .replace(/\s+$/, '');
      otherHolidayDates.set(date, label);

      if (prebooked) {
        prebookedDates.add(date);
      }
    }
  });
}

function changeInInputs() {
  const year = parseInt(yearSelect.value, 10);
  setPublicHolidays(year);
  processOtherHolidayDates();
  renderCalendars(year);
  refreshSelectionsUI();
  updateTotals();
}

/* ------------------ Initialization ------------------ */
async function init() {
  setTheme();
  buildYearOptions();
  // Fetch bank-holidays once, store globally
  publicHolidaysRawData = await fetchBankHolidays();
  attachControls();

  changeInInputs();
}

init();
</script>
</body>
</html>
